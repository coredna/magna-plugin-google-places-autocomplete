{"version":3,"file":"magna-plugin-google-places-autocomplete.esm.js","sources":["../src/index.js"],"sourcesContent":["import $ from 'jquery'\r\nimport { Plugin, State } from '@coredna/magna'\r\n\r\nexport default class GooglePlacesAutocomplete extends Plugin {\r\n\r\n  [Symbol.toStringTag] = 'GooglePlacesAutocomplete'\r\n\r\n  autocomplete = null\r\n\r\n  _state = new State({})\r\n\r\n  /**\r\n   * Using this format you can specify the fields you wish to use from google autocomplete and their matching input selector\r\n   *\r\n   * @type {{country: {selector: string, type: string}, unit: {selector: string, type: string}, address: {selector: string, type: string}, city: {selector: string, type: string}, postcode: {selector: string, type: string}, state: {selector: string, type: string}}}\r\n   */\r\n   static prefixDefaultFields = prefix => ({\r\n    country:  { selector: `[name=\"${prefix}countryid\"]`, type: 'short_name' },\r\n    unit:     { selector: `[name=\"${prefix}address2\"]`, type: 'long_name' },\r\n    address:  { selector: `[name=\"${prefix}address1\"]`, type: 'long_name' },\r\n    postcode: { selector: `[name=\"${prefix}postcode\"]`, type: 'short_name' },\r\n    city:     { selector: `[name=\"${prefix}city\"]`, type: 'long_name' },\r\n    state:    { selector: `[name=\"${prefix}state\"]`, type: 'short_name' },\r\n  })\r\n\r\n  // Create the default fields without a prefix\r\n  static defaultFields = GooglePlacesAutocomplete.prefixDefaultFields('')\r\n\r\n  static defaultConfig = {\r\n    API_KEY: '',\r\n    country: 'US',\r\n    fields: {},\r\n    language: 'en-US',\r\n    selector: '#google-autocomplete',\r\n  }\r\n\r\n  constructor(config) {\r\n    super(config);\r\n    if (!this.config.API_KEY)\r\n      throw new Error('missing google places API_KEY from config')\r\n  }\r\n\r\n  initPromise({ request }) {\r\n    return this.#loadPlacesApi({ request, config: this.config })\r\n  }\r\n\r\n  init({ request, config }) {\r\n    this._state.subscribe('fields', this.config.updateFields || this.updateFields)\r\n  }\r\n\r\n\r\n  #reduceAddressComponents = (addressComponents, accumulator = {}) => {\r\n    // loop through  all the components in the componentForm object\r\n    Object.keys(componentForm).forEach(key => {\r\n      const component = componentForm[key]\r\n      const field = this.config.fields[component.name]\r\n      if (!field) return\r\n      // loop through each address item to find the value we are looking for\r\n      for (let ii = 0; ii < addressComponents.length; ii++) {\r\n        const addressItem = addressComponents[ii]\r\n        // if we find an addressItem with a matching type use it to set the field\r\n        if (addressItem.types.includes(key)) {\r\n          accumulator[component.name] = addressItem[field.type || component.type]\r\n        }\r\n      }\r\n    })\r\n    return accumulator\r\n  }\r\n\r\n  #initializeAutocomplete() {\r\n    // don't initialize the autocomplete on localhost as the google api key will fail\r\n    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1')\r\n      return false\r\n    this.$input = $(this.config.selector)\r\n    // initialize google autocomplete\r\n    this.autocomplete = new google.maps.places.Autocomplete(\r\n      this.$input.get(0),\r\n      {\r\n        types: ['geocode'],\r\n        componentRestrictions: { country: this.config.country }\r\n      });\r\n    this.autocomplete.addListener('place_changed', this.onPlaceChanged);\r\n    // disable the enter key in the autosuggest\r\n    this.$input.on('keydown keyup keypress', this.#disableEnter)\r\n  }\r\n\r\n  onPlaceChanged = () => {\r\n    const place = this.autocomplete.getPlace();\r\n    // allow access to the place from the configuration\r\n    if (typeof this.config.onPlaceChanged === 'function') {\r\n      const result = this.config.onPlaceChanged.call(this, place)\r\n      // allow overriding the default behavior by returning false\r\n      if (result === false) {\r\n        return\r\n      }\r\n    }\r\n    const addressComponents = place.address_components\r\n    const fields = this.#reduceAddressComponents(addressComponents)\r\n    const value = this.$input.val()\r\n    // the street address that is returned from google generally misses unit numbers\r\n    // we will grab everything before the first comma to set the street address\r\n    const address = value.substr(0, value.indexOf(','))\r\n\r\n    this._state.setState('fields', _ => ({\r\n      ...fields,\r\n      address,\r\n    }))\r\n    // the original google address response is saved incase there are any issues\r\n    this._state.addressComponents = addressComponents\r\n  }\r\n\r\n  updateFields = values => {\r\n    Object.keys(this.config.fields).forEach(key => {\r\n      const field = this.config.fields[key]\r\n      $(field.selector).val(values[key])\r\n    })\r\n  }\r\n\r\n\r\n  #loadPlacesApi = ({ config }) => new Promise((res, rej) => {\r\n    if (window?.google?.maps) {\r\n      this.#initializeAutocomplete()\r\n      return res()\r\n    }\r\n    window.initAutocomplete = this.#initializeAutocomplete.bind(this)\r\n    const script = document.createElement('script')\r\n    script.src=`https://maps.google.com/maps/api/js?` + $.param({\r\n      libraries: 'places',\r\n      language: config.language,\r\n      callback: 'initAutocomplete',\r\n      key: config.API_KEY\r\n    })\r\n    script.onload = () => res({ success: true, message: 'google autocomplete loaded' })\r\n    script.onerror = () => rej(new Error('failed to load google places autocomplete'))\r\n    document.head.appendChild(script)\r\n  })\r\n\r\n  #disableEnter = e => {\r\n    if (e.keyCode === 13) {\r\n      e.preventDefault()\r\n      e.stopPropagation()\r\n    }\r\n  }\r\n\r\n}\r\n/*\r\n * this will attempt to find the most relevant piece of information from the google response\r\n * we will loop through each key until we find one that matches\r\n * */\r\nconst componentForm = {\r\n  street_number: {\r\n    type: 'short_name',\r\n    name: 'street_number',\r\n  },\r\n  route: {\r\n    type: 'short_name',\r\n    name: 'street',\r\n  },\r\n  colloquial_area: {\r\n    type: 'long_name',\r\n    name: 'city',\r\n  },\r\n  postal_town: {\r\n    type: 'short_name',\r\n    name: 'city',\r\n  },\r\n  neighborhood: {\r\n    type: 'long_name',\r\n    name: 'city',\r\n  },\r\n  sublocality: {\r\n    type: 'long_name',\r\n    name: 'city',\r\n  },\r\n  locality: {\r\n    type: 'long_name',\r\n    name: 'city',\r\n  },\r\n  postal_code_prefix: {\r\n    type: 'short_name',\r\n    name: 'postcode',\r\n  },\r\n  postal_code: {\r\n    type: 'short_name',\r\n    name: 'postcode',\r\n  },\r\n  administrative_area_level_1: {\r\n    type: 'short_name',\r\n    name: 'state',\r\n  },\r\n  country: {\r\n    type: 'short_name',\r\n    name: 'countryId'\r\n  }\r\n}\r\n"],"names":["Symbol","toStringTag","GooglePlacesAutocomplete","config","State","addressComponents","accumulator","Object","keys","componentForm","forEach","key","component","field","fields","name","ii","length","addressItem","types","includes","type","place","autocomplete","getPlace","onPlaceChanged","result","call","address_components","value","$input","val","address","substr","indexOf","_state","setState","_","values","$","selector","Promise","res","rej","window","google","maps","initAutocomplete","bind","script","document","createElement","src","param","libraries","language","callback","API_KEY","onload","success","message","onerror","Error","head","appendChild","e","keyCode","preventDefault","stopPropagation","request","subscribe","updateFields","Plugin","prefix","country","unit","postcode","city","state","prefixDefaultFields","location","hostname","places","Autocomplete","get","componentRestrictions","addListener","on","street_number","route","colloquial_area","postal_town","neighborhood","sublocality","locality","postal_code_prefix","postal_code","administrative_area_level_1"],"mappings":"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"}