{"version":3,"file":"magna-plugin-google-places-autocomplete.common.js","sources":["../src/index.js"],"sourcesContent":["import $ from 'jquery'\r\nimport { Plugin, State } from '@coredna/magna'\r\n\r\nexport default class GooglePlacesAutocomplete extends Plugin {\r\n\r\n  [Symbol.toStringTag] = 'GooglePlacesAutocomplete'\r\n\r\n  autocomplete = null\r\n\r\n  _state = new State({})\r\n\r\n  /**\r\n   * Using this format you can specify the fields you wish to use from google autocomplete and their matching input selector\r\n   *\r\n   * @type {{country: {selector: string, type: string}, unit: {selector: string, type: string}, address: {selector: string, type: string}, city: {selector: string, type: string}, postcode: {selector: string, type: string}, state: {selector: string, type: string}}}\r\n   */\r\n   static prefixDefaultFields = prefix => ({\r\n    country:  { selector: `[name=\"${prefix}countryid\"]`, type: 'short_name' },\r\n    unit:     { selector: `[name=\"${prefix}address2\"]`, type: 'long_name' },\r\n    address:  { selector: `[name=\"${prefix}address1\"]`, type: 'long_name' },\r\n    postcode: { selector: `[name=\"${prefix}postcode\"]`, type: 'short_name' },\r\n    city:     { selector: `[name=\"${prefix}city\"]`, type: 'long_name' },\r\n    state:    { selector: `[name=\"${prefix}state\"]`, type: 'short_name' },\r\n  })\r\n\r\n  // Create the default fields without a prefix\r\n  static defaultFields = GooglePlacesAutocomplete.prefixDefaultFields('')\r\n\r\n\r\n  static defaultConfig = {\r\n    API_KEY: '',\r\n    country: 'US',\r\n    fields: {},\r\n    language: 'en-US',\r\n    selector: '#google-autocomplete',\r\n  }\r\n\r\n\r\n  constructor(config) {\r\n    super(config);\r\n  }\r\n\r\n\r\n  initPromise({ request }) {\r\n    return this.#loadPlacesApi({ request, config: this.config })\r\n  }\r\n\r\n\r\n  init({ request, config }) {\r\n    if (!this.config.API_KEY)\r\n      throw new Error('missing google places API_KEY from GooglePlacesAutocomplete config')\r\n    this._state.subscribe('fields', this.config.updateFields || this.updateFields)\r\n  }\r\n\r\n\r\n  #reduceAddressComponents = (addressComponents, accumulator = {}) =>\r\n    // key the address components by their first declared type\r\n    addressComponents.reduce((acc, x) => ({\r\n      ...acc,\r\n      [x.types[0]]: {\r\n        long_name: x.long_name,\r\n        short_name: x.short_name,\r\n      }\r\n    }), {})\r\n\r\n\r\n  #normalizeAddressComponents = addressObj =>\r\n    // loop through componentForm attempting to fill in each `name` in the fields object using the `key` for the address object above\r\n    componentForm.reduce((acc, { key, type, name }) => ({\r\n      ...acc,\r\n      ...(typeof acc[name] === 'undefined' && {\r\n        [name]: addressObj[key]\r\n      })\r\n    }), {})\r\n\r\n\r\n  #initializeAutocomplete() {\r\n    // don't initialize the autocomplete on localhost as the google api key will fail\r\n    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1')\r\n      return false\r\n    this.$input = $(this.config.selector)\r\n    // initialize google autocomplete\r\n    this.autocomplete = new google.maps.places.Autocomplete(\r\n      this.$input.get(0),\r\n      {\r\n        types: ['geocode'],\r\n        componentRestrictions: { country: this.config.country }\r\n      });\r\n    this.autocomplete.addListener('place_changed', this.onPlaceChanged);\r\n    // disable the enter key in the autosuggest\r\n    this.$input.on('keydown keyup keypress', this.#disableEnter)\r\n  }\r\n\r\n  onPlaceChanged = () => {\r\n    const value = this.$input.val()\r\n    // the street address that is returned from google generally misses unit numbers\r\n    // we will grab everything before the first comma to set the street address\r\n    const address = value.substr(0, value.indexOf(','))\r\n\r\n    const place = this.autocomplete.getPlace();\r\n    const addressComponents = place.address_components\r\n    const addressComponentObject = this.#reduceAddressComponents(addressComponents)\r\n    const normalized = this.#normalizeAddressComponents(addressComponentObject)\r\n    // take the normalized field values, using the type specified in the `fields` object\r\n    const fields = Object.keys(this.config.fields).reduce((acc, key) => ({\r\n      ...acc,\r\n      ...(typeof normalized[key] !== 'undefined' && {\r\n        [key]: normalized[key][this.config.fields[key].type]\r\n      }),\r\n    }), { address })\r\n    // allow access to the place from the configuration\r\n    if (typeof this.config.onPlaceChanged === 'function') {\r\n      const result = this.config.onPlaceChanged.call(this, {\r\n        place,\r\n        addressComponentObject,\r\n        address: normalized,\r\n        fields\r\n      })\r\n      // allow overriding the default behavior by returning false\r\n      if (result === false) {\r\n        return\r\n      }\r\n    }\r\n\r\n    this._state.setState('fields', _ => fields)\r\n    // the original google address response is saved incase there are any issues\r\n    this._state.addressComponents = addressComponents\r\n  }\r\n\r\n\r\n  updateFields = values => {\r\n    Object.keys(this.config.fields).forEach(key => {\r\n      const field = this.config.fields[key]\r\n      $(field.selector).val(values[key])\r\n    })\r\n  }\r\n\r\n\r\n  #loadPlacesApi = ({ config }) => new Promise((res, rej) => {\r\n    if (window?.google?.maps) {\r\n      this.#initializeAutocomplete()\r\n      return res()\r\n    }\r\n    window.initAutocomplete = this.#initializeAutocomplete.bind(this)\r\n    const script = document.createElement('script')\r\n    script.src=`https://maps.google.com/maps/api/js?` + $.param({\r\n      libraries: 'places',\r\n      language: config.language,\r\n      callback: 'initAutocomplete',\r\n      key: config.API_KEY\r\n    })\r\n    script.onload = () => res({ success: true, message: 'google autocomplete loaded' })\r\n    script.onerror = () => rej(new Error('failed to load google places autocomplete'))\r\n    document.head.appendChild(script)\r\n  })\r\n\r\n\r\n  #disableEnter = e => {\r\n    if (e.keyCode === 13) {\r\n      e.preventDefault()\r\n      e.stopPropagation()\r\n    }\r\n  }\r\n\r\n}\r\n/*\r\n * this will attempt to find the most relevant piece of information from the google response\r\n * to normalize the names to more closely match core dna. we will loop through each key until we find one that matches\r\n * */\r\n\r\n/**\r\n *\r\n * @param {String}  name  name of the normalized key\r\n * @param {Array<String>}  order  order of lookup for the google address component type, higher index means higher precedence\r\n * @returns {key, name}\r\n */\r\nconst createComponentLookup = (name, order) =>\r\n  order.map(key => ({\r\n    key,\r\n    name\r\n  }))\r\n\r\nconst componentForm = [\r\n  ...createComponentLookup('street_number', ['street_number']),\r\n  ...createComponentLookup('street', ['street']),\r\n  ...createComponentLookup('city', ['locality', 'sublocality', 'neighborhood', 'postal_town', 'colloquial_area']),\r\n  ...createComponentLookup('suburb', ['postal_town', 'neighborhood', 'colloquial_area', 'locality', 'sublocality']),\r\n  ...createComponentLookup('postcode', ['postal_code', 'postal_code_prefix']),\r\n  ...createComponentLookup('state', ['administrative_area_level_1', 'administrative_area_level_2']),\r\n  ...createComponentLookup('country', ['country']),\r\n]\r\n"],"names":["Symbol","toStringTag","GooglePlacesAutocomplete","config","State","addressComponents","reduce","acc","x","types","long_name","short_name","addressObj","componentForm","key","type","name","value","$input","val","address","substr","indexOf","place","autocomplete","getPlace","address_components","addressComponentObject","normalized","fields","Object","keys","onPlaceChanged","result","call","_state","setState","_","values","forEach","field","$","selector","Promise","res","rej","window","google","maps","initAutocomplete","bind","script","document","createElement","src","param","libraries","language","callback","API_KEY","onload","success","message","onerror","Error","head","appendChild","e","keyCode","preventDefault","stopPropagation","request","subscribe","updateFields","Plugin","prefix","country","unit","postcode","city","state","prefixDefaultFields","location","hostname","places","Autocomplete","get","componentRestrictions","addListener","on","createComponentLookup","order","map"],"mappings":"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"}